import"./device-CAsdAK37.js";import{s as V,c as E,u as N,g as z,a as R}from"./peercomputeDevice-B7XJIp50.js";class X{constructor(e){this.device=e,this.domains=[]}addDomain(e){return this.domains.push(e),e}step(e,t){const n=!!t,a=t??this.device.createCommandEncoder({label:"engine-step"});let o=!1;for(const s of this.domains)!s||typeof s.step!="function"||(s.step.length>=2?(s.step(a,e),o=!0):s.step(e));if(!n){const s=a.finish();o&&this.device.queue.submit([s])}}}function T(r){const{device:e,particleCount:t,gridSize:n,iterations:a,constants:o,posVelBuffer:s,particleData:i,blockOptions:l={}}=r;if(!e)throw new Error("device is required");if(!t)throw new Error("particleCount is required");if(!n)throw new Error("gridSize {x,y,z} is required");const c=V(e,{particleCount:t,gridSize:n,posVelBuffer:s,constants:o,iterations:a}),d=i??E({count:t,gridSize:n,...l});N(e,c.buffers.particleBuffer,d);const g=new X(e);return g.addDomain(c.domain),{engine:g,...c,step:(m=o&&o.dt||.2)=>{const u=e.createCommandEncoder({label:"mpm-headless-step"});c.domain.step(u,m),e.queue.submit([u.finish()])}}}const F="modulepreload",L=function(r,e){return new URL(r,e).href},A={},D=function(e,t,n){let a=Promise.resolve();if(t&&t.length>0){const s=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),l=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));a=Promise.allSettled(t.map(c=>{if(c=L(c,n),c in A)return;A[c]=!0;const d=c.endsWith(".css"),g=d?'[rel="stylesheet"]':"";if(!!n)for(let u=s.length-1;u>=0;u--){const f=s[u];if(f.href===c&&(!d||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${g}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":F,d||(m.as="script"),m.crossOrigin="",m.href=c,l&&m.setAttribute("nonce",l),document.head.appendChild(m),d)return new Promise((u,f)=>{m.addEventListener("load",u),m.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return a.then(s=>{for(const i of s||[])i.status==="rejected"&&o(i.reason);return e().catch(o)})};class Y{constructor(e={}){const t=typeof navigator<"u"&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:4;this.config={enableWebGPU:e.enableWebGPU||!1,enableWorkers:e.enableWorkers!==!1,maxWorkers:e.maxWorkers||t,...e},this.workers=[],this.taskQueue=[],this.activeTasks=new Map,this.commitDeltaHandler=null,this.capabilities={cpu:!0,webgpu:!1},this.initialized=!1}setCommitDeltaHandler(e){this.commitDeltaHandler=e}commitDelta(e){this.commitDeltaHandler&&this.commitDeltaHandler(e)}async initialize(){if(this.initialized)return;if(this.initialized=!0,!(typeof Worker<"u"&&this.config.enableWorkers)){console.warn("[ComputeManager] Web Workers not available; falling back to inline execution");return}const t=new URL("data:text/javascript;base64,LyogZXNsaW50LWRpc2FibGUgbm8tcmVzdHJpY3RlZC1nbG9iYWxzICovCgpzZWxmLm9ubWVzc2FnZSA9IGFzeW5jIChldmVudCkgPT4gewogIGNvbnN0IG1zZyA9IGV2ZW50LmRhdGE7CiAgaWYgKCFtc2cgfHwgbXNnLnR5cGUgIT09ICdydW4nKSByZXR1cm47CiAgY29uc3QgeyBpZCwgZGF0YSwgZm4sIG1vZHVsZSwgZXhwb3J0TmFtZSB9ID0gbXNnOwogIHRyeSB7CiAgICBsZXQgaGFuZGxlcjsKICAgIGlmIChmbikgewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbmV3LWZ1bmMKICAgICAgaGFuZGxlciA9IG5ldyBGdW5jdGlvbihgcmV0dXJuICgke2ZufSk7YCkoKTsKICAgIH0gZWxzZSBpZiAobW9kdWxlKSB7CiAgICAgIC8vIFNpbGVuY2Ugd2VicGFjaydzICJkZXBlbmRlbmN5IGlzIGFuIGV4cHJlc3Npb24iIHdhcm5pbmcgYnkgZXhwbGljaXRseSBpZ25vcmluZyBidW5kbGluZyBoZXJlLgogICAgICAvLyBUaGUgd29ya2VyIGV4cGVjdHMgYSByZWFsIFVSTCBzdHJpbmcgcGFzc2VkIGluIGZyb20gdGhlIG1haW4gdGhyZWFkLgogICAgICBjb25zdCBtb2QgPSBhd2FpdCBpbXBvcnQoCiAgICAgICAgLyogd2VicGFja0lnbm9yZTogdHJ1ZSAqLwogICAgICAgIG1vZHVsZQogICAgICApOwogICAgICBoYW5kbGVyID0gbW9kW2V4cG9ydE5hbWUgfHwgJ2RlZmF1bHQnXTsKICAgIH0KICAgIGlmICh0eXBlb2YgaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhbmRsZXIgbm90IGZvdW5kIGZvciB0YXNrJyk7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGRhdGEpOwogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICdyZXN1bHQnLCBpZCwgcmVzdWx0IH0pOwogIH0gY2F0Y2ggKGVycikgewogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICdlcnJvcicsIGlkLCBlcnJvcjogZXJyPy5tZXNzYWdlIHx8IFN0cmluZyhlcnIpIH0pOwogIH0KfTsK",import.meta.url),n=Math.max(1,Math.min(this.config.maxWorkers,128));for(let a=0;a<n;a++){const o=new Worker(t,{type:"module"});o.onmessage=s=>this._handleWorkerMessage(o,s.data),o.onerror=s=>console.error("[ComputeManager] Worker error",s),this.workers.push(o)}}async submitTask(e){if(!e)throw new Error("Task is required");if(!e.fn&&!e.module)throw new Error("Task must provide fn or module");const t=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`,n=e.id||t,a={id:n,data:e.data??null,fn:e.fn?e.fn.toString():void 0,module:e.module,exportName:e.exportName||"default"};return this.initialized||await this.initialize(),new Promise((o,s)=>{const i={id:n,payload:a,resolve:o,reject:s};this._dispatchToWorker(i)||(this.taskQueue.push(i),this._scheduleNext())})}async distributeTask(e,t){}async cancelTask(e){}getCapabilities(){return{...this.capabilities,workers:this.workers.length,activeTaskCount:this.activeTasks.size,queuedTaskCount:this.taskQueue.length}}getStats(){return{totalTasksCompleted:0,averageTaskDuration:0,currentLoad:0}}async _executeTask(e){}_scheduleNext(){}_handleTaskComplete(e,t){}_handleTaskError(e,t){}_dispatchToWorker(e){const t=this.workers.find(n=>!Array.from(this.activeTasks.values()).some(a=>a.worker===n));return t?(this.activeTasks.set(e.id,{...e,worker:t}),t.postMessage({type:"run",...e.payload}),!0):!1}async _executeInline(e){try{let t;if(e.payload.fn)t=new Function(`return (${e.payload.fn});`)();else if(e.payload.module){if(typeof e.payload.module!="string")throw new Error("module path must be a string");t=(await D(()=>import(`${e.payload.module}`),[],import.meta.url))[e.payload.exportName||"default"]}const n=await t(e.payload.data);if(n&&typeof n=="object"&&Object.prototype.hasOwnProperty.call(n,"commitDelta")){this.commitDelta(n.commitDelta);const a=Object.prototype.hasOwnProperty.call(n,"value")?n.value:n.result;e.resolve(a);return}e.resolve(n)}catch(t){e.reject(t)}}_handleWorkerMessage(e,t){const{id:n,type:a,result:o,error:s}=t||{},i=this.activeTasks.get(n);if(i){if(a==="result"){let l=o;o&&typeof o=="object"&&Object.prototype.hasOwnProperty.call(o,"commitDelta")&&(this.commitDelta(o.commitDelta),l=Object.prototype.hasOwnProperty.call(o,"value")?o.value:o.result),i.resolve(l)}else a==="error"&&i.reject(new Error(s||"Worker task failed"));this.activeTasks.delete(n),this._scheduleNext()}}_scheduleNext(){if(this.taskQueue.length===0)return;const e=this.taskQueue.shift();if(this.workers.length===0){this._executeInline(e);return}this._dispatchToWorker(e)||this.taskQueue.unshift(e)}}const y=document.getElementById("status"),M=document.getElementById("particleCount"),P=document.getElementById("gridSize"),_=document.getElementById("mass"),J=document.getElementById("massDelta"),U=document.getElementById("momentum"),O=document.getElementById("momentumDelta"),K=document.getElementById("checks"),G=document.getElementById("toggleBtn"),j=document.getElementById("resetBtn"),Q=document.getElementById("error"),q=["Hydrogen","Oxygen","Sodium","Potassium","Magnesium","Aluminum","Silicon","Calcium","Titanium","Iron","Lead"],Z=new URL("data:text/javascript;base64,aW1wb3J0IHsgaW5pdFdlYkdQVSwgbXBtIH0gZnJvbSAnLi4vLi4vc3JjL2luZGV4LmpzJzsKCmxldCBkZXZpY2UgPSBudWxsOwpsZXQgc2ltID0gbnVsbDsKbGV0IHBhcnRpY2xlQ291bnQgPSAwOwoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRIZWFkbGVzc1NpbSh7CiAgcGFydGljbGVDb3VudDogbmV4dENvdW50LAogIGdyaWRTaXplLAogIGl0ZXJhdGlvbnMsCiAgYmxvY2tPcHRpb25zLAogIGNvbnN0YW50cwp9ID0ge30pIHsKICBpZiAoIW5leHRDb3VudCB8fCAhZ3JpZFNpemUgfHwgIWJsb2NrT3B0aW9ucyB8fCAhY29uc3RhbnRzKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgaW5pdGlhbGl6YXRpb24gZGF0YSBmb3IgaGVhZGxlc3MgTVBNJyk7CiAgfQogIGlmICghZGV2aWNlKSB7CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpbml0V2ViR1BVKCk7CiAgICBkZXZpY2UgPSByZXN1bHQuZGV2aWNlOwogIH0KICBwYXJ0aWNsZUNvdW50ID0gbmV4dENvdW50OwogIHNpbSA9IG1wbS5jcmVhdGVIZWFkbGVzc01wbSh7CiAgICBkZXZpY2UsCiAgICBwYXJ0aWNsZUNvdW50LAogICAgZ3JpZFNpemUsCiAgICBpdGVyYXRpb25zLAogICAgYmxvY2tPcHRpb25zLAogICAgY29uc3RhbnRzCiAgfSk7CiAgcmV0dXJuIHsgb2s6IHRydWUgfTsKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0ZXBIZWFkbGVzc1NpbSh7IHN0ZXBzID0gMSwgZGlhZ25vc3RpY3MgPSBmYWxzZSB9ID0ge30pIHsKICBpZiAoIXNpbSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdTaW11bGF0aW9uIG5vdCBpbml0aWFsaXplZCcpOwogIH0KICBjb25zdCBzYWZlU3RlcHMgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKHN0ZXBzKSk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYWZlU3RlcHM7IGkrKykgewogICAgc2ltLnN0ZXAoKTsKICB9CiAgaWYgKCFkaWFnbm9zdGljcykgewogICAgcmV0dXJuIHsgc3RlcHM6IHNhZmVTdGVwcyB9OwogIH0KICBjb25zdCB7IG1hc3MsIG1vbWVudHVtIH0gPSBhd2FpdCBtcG0uY29tcHV0ZU1hc3NNb21lbnR1bShkZXZpY2UsIHNpbS5idWZmZXJzLnBhcnRpY2xlQnVmZmVyLCBwYXJ0aWNsZUNvdW50KTsKICByZXR1cm4geyBzdGVwczogc2FmZVN0ZXBzLCBtYXNzLCBtb21lbnR1bSB9Owp9CgpleHBvcnQgZnVuY3Rpb24gcmVzZXRIZWFkbGVzc1NpbSgpIHsKICBzaW0gPSBudWxsOwogIHBhcnRpY2xlQ291bnQgPSAwOwogIHJldHVybiB7IG9rOiB0cnVlIH07Cn0K",import.meta.url).href;let C=null,p=!0,w=0,k=0,I=!1,h=null;const $=.01,ee=.01,v=.005,x=[.8,.8,1,1.1,.95,1,.95,1.1,1,1,1],te=[2e-4,2e-4,3e-4,3e-4,25e-5,2e-4,15e-5,25e-5,18e-5,17e-5,16e-5],ne=[.05,.05,.08,.1,.07,.05,.05,.08,.06,.05,.05];function oe(r,e,t){const n=Math.max(0,Math.min(r,x.length-1)),a=x[n],o=te[n],s=ne[n],i=e-300;let l=a*(1+o*i);const c=1/Math.max(.2,1+.1*(t-1));l*=c,l=Math.min(Math.max(l,.4),2.5);let d=s+Math.abs(i)*1e-4+Math.max(0,t-1)*.02;return d=Math.min(Math.max(d,0),.6),{spacing:l,jitter:d}}const W={stiffness:2.5,restDensity:4,dynamicViscosity:.08,dt:v,fixedPointScale:1e5};function b(r){y.textContent=r}function B(r){console.error(r),Q.textContent=(r==null?void 0:r.stack)||String(r),b("error"),p=!1,G.disabled=!0}function H({mass:r,momentum:e}){k=k*.7+.3*2,_.textContent=r.toFixed(4),U.textContent=e.map(o=>o.toFixed(4)).join(", "),h||(h={mass:r,momentum:e});const t=h?r-h.mass:0,n=h?e.map((o,s)=>o-h.momentum[s]):[0,0,0];J.textContent=t.toExponential(3),O.textContent=n.map(o=>o.toExponential(3)).join(", ");const a=Math.hypot(n[0],n[1],n[2]);Math.abs(t)>$||a>ee?y.textContent=`drift detected (Δm=${t.toExponential(2)}, |Δp|=${a.toExponential(2)})`:p&&(y.textContent="running"),K.textContent=k.toFixed(1)}G.addEventListener("click",()=>{p=!p,G.textContent=p?"Pause":"Resume",b(p?"running":"paused")});j.addEventListener("click",()=>{h=null,y.textContent="baseline reset"});async function se({particleCount:r,gridSize:e,iterations:t,blockOptions:n,stepsRequested:a}){const o=new Y({maxWorkers:1});await o.initialize(),await o.submitTask({module:Z,exportName:"initHeadlessSim",data:{particleCount:r,gridSize:e,iterations:t,blockOptions:n,constants:W}});let s=0,i=!1;window.__mpmStarted=!1;function l(c){if(p&&!i&&(i=!0,o.submitTask({module:Z,exportName:"stepHeadlessSim",data:{steps:1,diagnostics:!1}}).then(()=>{s+=1,window.__mpmStarted=!0}).catch(B).finally(()=>{i=!1})),!I&&c-w>500&&(I=!0,w=c,o.submitTask({module:Z,exportName:"stepHeadlessSim",data:{steps:0,diagnostics:!0}}).then(({mass:d,momentum:g})=>H({mass:d,momentum:g})).catch(B).finally(()=>{I=!1})),a>0&&s>=a){window.__mpmDone=!0,window.__mpmStepsRan=s;return}requestAnimationFrame(l)}requestAnimationFrame(l)}async function ae({device:r,particleCount:e,gridSize:t,iterations:n,blockOptions:a,stepsRequested:o}){C=T({device:r,particleCount:e,gridSize:t,iterations:n,blockOptions:a,constants:W}),window.__mpmStarted=!1;let s=0;function i(l){if(p&&C&&(C.step(),window.__mpmStarted=!0,s+=1),C&&!I&&l-w>500&&(I=!0,w=l,R(r,C.buffers.particleBuffer,e).then(({mass:c,momentum:d})=>H({mass:c,momentum:d})).catch(B).finally(()=>{I=!1})),o>0&&s>=o){window.__mpmDone=!0,window.__mpmStepsRan=s;return}requestAnimationFrame(i)}requestAnimationFrame(i)}async function ie(){try{b("initializing WebGPU…");const r=new URLSearchParams(window.location.search),t=(r.get("compute")||"isolated").toLowerCase()!=="shared",n=parseInt(r.get("count")||"1000",10),a={x:32,y:32,z:32},o=r.get("material")||"Oxygen",s=Math.max(0,q.indexOf(o)),i=r.get("temp"),l=parseInt(r.get("steps")||"0",10),c=Math.ceil(Math.cbrt(n)),d=oe(s,i?parseFloat(i):300,W.ambientPressure||1),g={start:[2,2,2],gridSize:a,jitter:d.jitter,spacing:d.spacing,materialType:s,cubeSideCount:c,temperature:i?parseFloat(i):void 0},m=Math.ceil(.05/v);if(M.textContent=n.toString(),P.textContent=`${a.x}×${a.y}×${a.z}`,b(t?"initializing isolated worker":"initializing shared GPU"),t)await se({particleCount:n,gridSize:a,iterations:m,blockOptions:g,stepsRequested:l});else{const u=await z();if(!u)throw new Error("Shared GPU device unavailable");await ae({device:u,particleCount:n,gridSize:a,iterations:m,blockOptions:g,stepsRequested:l})}b("running")}catch(r){B(r)}}ie();
