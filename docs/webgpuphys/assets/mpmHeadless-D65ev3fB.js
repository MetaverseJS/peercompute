import"./device-CAsdAK37.js";import{s as E,c as N,u as z,g as R,a as X}from"./peercomputeDevice-BwGslQDx.js";class T{constructor(e){this.device=e,this.domains=[]}addDomain(e){return this.domains.push(e),e}step(e,t){const n=!!t,a=t??this.device.createCommandEncoder({label:"engine-step"});let o=!1;for(const s of this.domains)!s||typeof s.step!="function"||(s.step.length>=2?(s.step(a,e),o=!0):s.step(e));if(!n){const s=a.finish();o&&this.device.queue.submit([s])}}}function F(i){const{device:e,particleCount:t,gridSize:n,iterations:a,constants:o,posVelBuffer:s,particleData:r,blockOptions:c={}}=i;if(!e)throw new Error("device is required");if(!t)throw new Error("particleCount is required");if(!n)throw new Error("gridSize {x,y,z} is required");const d=E(e,{particleCount:t,gridSize:n,posVelBuffer:s,constants:o,iterations:a}),l=r??N({count:t,gridSize:n,...c});z(e,d.buffers.particleBuffer,l);const m=new T(e);return m.addDomain(d.domain),{engine:m,...d,step:(C=o&&o.dt||.2)=>{const u=e.createCommandEncoder({label:"mpm-headless-step"});d.domain.step(u,C),e.queue.submit([u.finish()])}}}const L="modulepreload",D=function(i,e){return new URL(i,e).href},x={},Y=function(e,t,n){let a=Promise.resolve();if(t&&t.length>0){let s=function(l){return Promise.all(l.map(m=>Promise.resolve(m).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),d=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));a=s(t.map(l=>{if(l=D(l,n),l in x)return;x[l]=!0;const m=l.endsWith(".css"),p=m?'[rel="stylesheet"]':"";if(!!n)for(let b=r.length-1;b>=0;b--){const w=r[b];if(w.href===l&&(!m||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${p}`))return;const u=document.createElement("link");if(u.rel=m?"stylesheet":L,m||(u.as="script"),u.crossOrigin="",u.href=l,d&&u.setAttribute("nonce",d),document.head.appendChild(u),m)return new Promise((b,w)=>{u.addEventListener("load",b),u.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return a.then(s=>{for(const r of s||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})};class M{constructor(e={}){const t=typeof navigator<"u"&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:4;this.config={enableWebGPU:e.enableWebGPU||!1,enableWorkers:e.enableWorkers!==!1,maxWorkers:e.maxWorkers||t,...e},this.workers=[],this.taskQueue=[],this.activeTasks=new Map,this.commitDeltaHandler=null,this.capabilities={cpu:!0,webgpu:!1},this.initialized=!1}setCommitDeltaHandler(e){this.commitDeltaHandler=e}commitDelta(e){this.commitDeltaHandler&&this.commitDeltaHandler(e)}async initialize(){if(this.initialized)return;if(this.initialized=!0,!(typeof Worker<"u"&&this.config.enableWorkers)){console.warn("[ComputeManager] Web Workers not available; falling back to inline execution");return}const t=new URL("data:text/javascript;base64,LyogZXNsaW50LWRpc2FibGUgbm8tcmVzdHJpY3RlZC1nbG9iYWxzICovCgpzZWxmLm9ubWVzc2FnZSA9IGFzeW5jIChldmVudCkgPT4gewogIGNvbnN0IG1zZyA9IGV2ZW50LmRhdGE7CiAgaWYgKCFtc2cgfHwgbXNnLnR5cGUgIT09ICdydW4nKSByZXR1cm47CiAgY29uc3QgeyBpZCwgZGF0YSwgZm4sIG1vZHVsZSwgZXhwb3J0TmFtZSB9ID0gbXNnOwogIHRyeSB7CiAgICBsZXQgaGFuZGxlcjsKICAgIGlmIChmbikgewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbmV3LWZ1bmMKICAgICAgaGFuZGxlciA9IG5ldyBGdW5jdGlvbihgcmV0dXJuICgke2ZufSk7YCkoKTsKICAgIH0gZWxzZSBpZiAobW9kdWxlKSB7CiAgICAgIC8vIFNpbGVuY2Ugd2VicGFjaydzICJkZXBlbmRlbmN5IGlzIGFuIGV4cHJlc3Npb24iIHdhcm5pbmcgYnkgZXhwbGljaXRseSBpZ25vcmluZyBidW5kbGluZyBoZXJlLgogICAgICAvLyBUaGUgd29ya2VyIGV4cGVjdHMgYSByZWFsIFVSTCBzdHJpbmcgcGFzc2VkIGluIGZyb20gdGhlIG1haW4gdGhyZWFkLgogICAgICBjb25zdCBtb2QgPSBhd2FpdCBpbXBvcnQoCiAgICAgICAgLyogd2VicGFja0lnbm9yZTogdHJ1ZSAqLwogICAgICAgIG1vZHVsZQogICAgICApOwogICAgICBoYW5kbGVyID0gbW9kW2V4cG9ydE5hbWUgfHwgJ2RlZmF1bHQnXTsKICAgIH0KICAgIGlmICh0eXBlb2YgaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhbmRsZXIgbm90IGZvdW5kIGZvciB0YXNrJyk7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGRhdGEpOwogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICdyZXN1bHQnLCBpZCwgcmVzdWx0IH0pOwogIH0gY2F0Y2ggKGVycikgewogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICdlcnJvcicsIGlkLCBlcnJvcjogZXJyPy5tZXNzYWdlIHx8IFN0cmluZyhlcnIpIH0pOwogIH0KfTsK",import.meta.url),n=Math.max(1,Math.min(this.config.maxWorkers,128));for(let a=0;a<n;a++){const o=new Worker(t,{type:"module"});o.onmessage=s=>this._handleWorkerMessage(o,s.data),o.onerror=s=>console.error("[ComputeManager] Worker error",s),this.workers.push(o)}}async submitTask(e){if(!e)throw new Error("Task is required");if(!e.fn&&!e.module)throw new Error("Task must provide fn or module");const t=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`,n=e.id||t,a={id:n,data:e.data??null,fn:e.fn?e.fn.toString():void 0,module:e.module,exportName:e.exportName||"default"};return this.initialized||await this.initialize(),new Promise((o,s)=>{const r={id:n,payload:a,resolve:o,reject:s};this._dispatchToWorker(r)||(this.taskQueue.push(r),this._scheduleNext())})}async distributeTask(e,t){}async cancelTask(e){}getCapabilities(){return{...this.capabilities,workers:this.workers.length,activeTaskCount:this.activeTasks.size,queuedTaskCount:this.taskQueue.length}}getStats(){return{totalTasksCompleted:0,averageTaskDuration:0,currentLoad:0}}async _executeTask(e){}_scheduleNext(){}_handleTaskComplete(e,t){}_handleTaskError(e,t){}_dispatchToWorker(e){const t=this.workers.find(n=>!Array.from(this.activeTasks.values()).some(a=>a.worker===n));return t?(this.activeTasks.set(e.id,{...e,worker:t}),t.postMessage({type:"run",...e.payload}),!0):!1}async _executeInline(e){try{let t;if(e.payload.fn)t=new Function(`return (${e.payload.fn});`)();else if(e.payload.module){if(typeof e.payload.module!="string")throw new Error("module path must be a string");t=(await Y(()=>import(`${e.payload.module}`),[],import.meta.url))[e.payload.exportName||"default"]}const n=await t(e.payload.data);if(n&&typeof n=="object"&&Object.prototype.hasOwnProperty.call(n,"commitDelta")){this.commitDelta(n.commitDelta);const a=Object.prototype.hasOwnProperty.call(n,"value")?n.value:n.result;e.resolve(a);return}e.resolve(n)}catch(t){e.reject(t)}}_handleWorkerMessage(e,t){const{id:n,type:a,result:o,error:s}=t||{},r=this.activeTasks.get(n);if(r){if(a==="result"){let c=o;o&&typeof o=="object"&&Object.prototype.hasOwnProperty.call(o,"commitDelta")&&(this.commitDelta(o.commitDelta),c=Object.prototype.hasOwnProperty.call(o,"value")?o.value:o.result),r.resolve(c)}else a==="error"&&r.reject(new Error(s||"Worker task failed"));this.activeTasks.delete(n),this._scheduleNext()}}_scheduleNext(){if(this.taskQueue.length===0)return;const e=this.taskQueue.shift();if(this.workers.length===0){this._executeInline(e);return}this._dispatchToWorker(e)||this.taskQueue.unshift(e)}}const B=document.getElementById("status"),P=document.getElementById("particleCount"),_=document.getElementById("gridSize"),J=document.getElementById("mass"),U=document.getElementById("massDelta"),O=document.getElementById("momentum"),j=document.getElementById("momentumDelta"),K=document.getElementById("checks"),S=document.getElementById("toggleBtn"),Q=document.getElementById("resetBtn"),q=document.getElementById("error"),$=["Hydrogen","Oxygen","Sodium","Potassium","Magnesium","Aluminum","Silicon","Calcium","Titanium","Iron","Lead"],G=new URL("data:text/javascript;base64,aW1wb3J0IHsgaW5pdFdlYkdQVSwgbXBtIH0gZnJvbSAnLi4vLi4vc3JjL2luZGV4LmpzJzsKCmxldCBkZXZpY2UgPSBudWxsOwpsZXQgc2ltID0gbnVsbDsKbGV0IHBhcnRpY2xlQ291bnQgPSAwOwoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRIZWFkbGVzc1NpbSh7CiAgcGFydGljbGVDb3VudDogbmV4dENvdW50LAogIGdyaWRTaXplLAogIGl0ZXJhdGlvbnMsCiAgYmxvY2tPcHRpb25zLAogIGNvbnN0YW50cwp9ID0ge30pIHsKICBpZiAoIW5leHRDb3VudCB8fCAhZ3JpZFNpemUgfHwgIWJsb2NrT3B0aW9ucyB8fCAhY29uc3RhbnRzKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgaW5pdGlhbGl6YXRpb24gZGF0YSBmb3IgaGVhZGxlc3MgTVBNJyk7CiAgfQogIGlmICghZGV2aWNlKSB7CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpbml0V2ViR1BVKCk7CiAgICBkZXZpY2UgPSByZXN1bHQuZGV2aWNlOwogIH0KICBwYXJ0aWNsZUNvdW50ID0gbmV4dENvdW50OwogIHNpbSA9IG1wbS5jcmVhdGVIZWFkbGVzc01wbSh7CiAgICBkZXZpY2UsCiAgICBwYXJ0aWNsZUNvdW50LAogICAgZ3JpZFNpemUsCiAgICBpdGVyYXRpb25zLAogICAgYmxvY2tPcHRpb25zLAogICAgY29uc3RhbnRzCiAgfSk7CiAgcmV0dXJuIHsgb2s6IHRydWUgfTsKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0ZXBIZWFkbGVzc1NpbSh7IHN0ZXBzID0gMSwgZGlhZ25vc3RpY3MgPSBmYWxzZSB9ID0ge30pIHsKICBpZiAoIXNpbSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdTaW11bGF0aW9uIG5vdCBpbml0aWFsaXplZCcpOwogIH0KICBjb25zdCBzYWZlU3RlcHMgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKHN0ZXBzKSk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYWZlU3RlcHM7IGkrKykgewogICAgc2ltLnN0ZXAoKTsKICB9CiAgaWYgKCFkaWFnbm9zdGljcykgewogICAgcmV0dXJuIHsgc3RlcHM6IHNhZmVTdGVwcyB9OwogIH0KICBjb25zdCB7IG1hc3MsIG1vbWVudHVtIH0gPSBhd2FpdCBtcG0uY29tcHV0ZU1hc3NNb21lbnR1bShkZXZpY2UsIHNpbS5idWZmZXJzLnBhcnRpY2xlQnVmZmVyLCBwYXJ0aWNsZUNvdW50KTsKICByZXR1cm4geyBzdGVwczogc2FmZVN0ZXBzLCBtYXNzLCBtb21lbnR1bSB9Owp9CgpleHBvcnQgZnVuY3Rpb24gcmVzZXRIZWFkbGVzc1NpbSgpIHsKICBzaW0gPSBudWxsOwogIHBhcnRpY2xlQ291bnQgPSAwOwogIHJldHVybiB7IG9rOiB0cnVlIH07Cn0K",import.meta.url).href;let f=null,g=!0,Z=0,W=0,I=!1,h=null;const ee=.01,te=.01,H=.005,v=[.8,.8,1,1.1,.95,1,.95,1.1,1,1,1],ne=[2e-4,2e-4,3e-4,3e-4,25e-5,2e-4,15e-5,25e-5,18e-5,17e-5,16e-5],oe=[.05,.05,.08,.1,.07,.05,.05,.08,.06,.05,.05];function se(i,e,t){const n=Math.max(0,Math.min(i,v.length-1)),a=v[n],o=ne[n],s=oe[n],r=e-300;let c=a*(1+o*r);const d=1/Math.max(.2,1+.1*(t-1));c*=d,c=Math.min(Math.max(c,.4),2.5);let l=s+Math.abs(r)*1e-4+Math.max(0,t-1)*.02;return l=Math.min(Math.max(l,0),.6),{spacing:c,jitter:l}}const A={stiffness:2.5,restDensity:4,dynamicViscosity:.08,dt:H,fixedPointScale:1e5};function y(i){B.textContent=i}function k(i){console.error(i),q.textContent=(i==null?void 0:i.stack)||String(i),y("error"),g=!1,S.disabled=!0}function V({mass:i,momentum:e}){W=W*.7+.3*2,J.textContent=i.toFixed(4),O.textContent=e.map(o=>o.toFixed(4)).join(", "),h||(h={mass:i,momentum:e});const t=h?i-h.mass:0,n=h?e.map((o,s)=>o-h.momentum[s]):[0,0,0];U.textContent=t.toExponential(3),j.textContent=n.map(o=>o.toExponential(3)).join(", ");const a=Math.hypot(n[0],n[1],n[2]);Math.abs(t)>ee||a>te?B.textContent=`drift detected (Δm=${t.toExponential(2)}, |Δp|=${a.toExponential(2)})`:g&&(B.textContent="running"),K.textContent=W.toFixed(1)}S.addEventListener("click",()=>{g=!g,S.textContent=g?"Pause":"Resume",y(g?"running":"paused")});Q.addEventListener("click",()=>{h=null,B.textContent="baseline reset"});async function ae({particleCount:i,gridSize:e,iterations:t,blockOptions:n,stepsRequested:a}){const o=new M({maxWorkers:1});await o.initialize(),await o.submitTask({module:G,exportName:"initHeadlessSim",data:{particleCount:i,gridSize:e,iterations:t,blockOptions:n,constants:A}});let s=0,r=!1;window.__mpmStarted=!1;function c(d){if(g&&!r&&(r=!0,o.submitTask({module:G,exportName:"stepHeadlessSim",data:{steps:1,diagnostics:!1}}).then(()=>{s+=1,window.__mpmStarted=!0}).catch(k).finally(()=>{r=!1})),!I&&d-Z>500&&(I=!0,Z=d,o.submitTask({module:G,exportName:"stepHeadlessSim",data:{steps:0,diagnostics:!0}}).then(({mass:l,momentum:m})=>V({mass:l,momentum:m})).catch(k).finally(()=>{I=!1})),a>0&&s>=a){window.__mpmDone=!0,window.__mpmStepsRan=s;return}requestAnimationFrame(c)}requestAnimationFrame(c)}async function ie({device:i,particleCount:e,gridSize:t,iterations:n,blockOptions:a,stepsRequested:o}){f=F({device:i,particleCount:e,gridSize:t,iterations:n,blockOptions:a,constants:A}),window.__mpmStarted=!1;let s=0;function r(c){if(g&&f&&(f.step(),window.__mpmStarted=!0,s+=1),f&&!I&&c-Z>500&&(I=!0,Z=c,X(i,f.buffers.particleBuffer,e).then(({mass:d,momentum:l})=>V({mass:d,momentum:l})).catch(k).finally(()=>{I=!1})),o>0&&s>=o){window.__mpmDone=!0,window.__mpmStepsRan=s;return}requestAnimationFrame(r)}requestAnimationFrame(r)}async function re(){try{y("initializing WebGPU…");const i=new URLSearchParams(window.location.search),t=(i.get("compute")||"isolated").toLowerCase()!=="shared",n=parseInt(i.get("count")||"1000",10),a={x:32,y:32,z:32},o=i.get("material")||"Oxygen",s=Math.max(0,$.indexOf(o)),r=i.get("temp"),c=parseInt(i.get("steps")||"0",10),d=Math.ceil(Math.cbrt(n)),l=se(s,r?parseFloat(r):300,A.ambientPressure||1),m={start:[2,2,2],gridSize:a,jitter:l.jitter,spacing:l.spacing,materialType:s,cubeSideCount:d,temperature:r?parseFloat(r):void 0},C=Math.ceil(.05/H);if(P.textContent=n.toString(),_.textContent=`${a.x}×${a.y}×${a.z}`,y(t?"initializing isolated worker":"initializing shared GPU"),t)await ae({particleCount:n,gridSize:a,iterations:C,blockOptions:m,stepsRequested:c});else{const u=await R();if(!u)throw new Error("Shared GPU device unavailable");await ie({device:u,particleCount:n,gridSize:a,iterations:C,blockOptions:m,stepsRequested:c})}y("running")}catch(i){k(i)}}re();
